<!DOCTYPE html>
<html lang="sv" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/40282c7580.js" crossorigin="anonymous"></script>
  <style>

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

   
    }
    body {
      font-family: , 'Inter',sans-serif;
      background-color: #ffffff;
      color: #0097b2;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
      min-height: 100vh;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      font-family: 'Quicksand', 'Inter',sans-serif;
    }

    input[type="date"] {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 20px;
      color: #ffffff;
      background-color: #0097b2;
      font-family: inherit;
    }

    button {
      background-color: #144953;
      color: #ffffff;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 30px;
    }

    button:hover {
      background-color: #0d3a3d;
    }

    ul#savedDates {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 400px;
    }

    ul#savedDates li {
      background-color: #ffffff;
      color: #000000;
      padding: 10px 16px;
      border-radius: 10px;
      margin-bottom: 10px;
      font-size: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input, button {
      margin: 10px 0;
    }
    .legend {
      max-width: 700px;
      margin: 40px auto 20px;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #a6a6a6;
      background-color: transparent;
    }

    .legend-items {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .color-box {
      width: 20px;
      height: 20px;
      border-radius: 4px;
    }

    .gron { background-color: #61d26c; }
    .rod { background-color: #c0392b; }
    .bla { background-color: #0097b2; }
    .gra { background-color: #a6a6a6; }

    .time-slot {
      border: 1px solid #a6a6a6;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #f9f7fb;
    }

    .time-slot button {
      background-color: #144953;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      margin-left: 10px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .time-slot button:hover {
      background-color: #0097b2;
    }

    .legend {
      max-width: 700px;
      margin: 40px auto 20px;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #a6a6a6;
      background-color: transparent;
    }
/* Header style */

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 38px;
  background: #fff;
  border-bottom: 1px solid #d9d9d9;
}

.logo {
  font-size: 24px;
  font-weight: bold;
  letter-spacing: -0.5px;
  text-decoration: none;
  background: linear-gradient(90deg, #10B781, #0D9688);
  background-clip: text;
  color: transparent;
  cursor: pointer;
}

.logo-link {
  text-decoration: none;
}

.nav {
  display: flex;
  align-items: center;
  gap: 28px;
}

.nav-link {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 16px;
  color: #1a202c;
  text-decoration: none;
  font-weight: bold;
}

.nav-link.logout {
  color: #ff4d4f;
  font-weight: 500;
  
}

.nav-link.logout:hover {
  color: #d9363e;
  cursor: pointer;
}

/* Mina bookning del */

.time-slot {
  background-color: #f9f7fb;
  border: 1px solid #a6a6a6;
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #000000;
}

.time-slot button {
  background-color: #144953;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  margin-left: 10px;
  transition: background-color 0.3s ease;
  font-size: 14px;
}

.time-slot button:hover {
  background-color: #0097b2;
}

    



  </style>
</head>
<body>
  <header>
    <a th:href="@{/default}" class="logo-link"><div class="logo">GrannSnack</div></a>
    <nav class="nav">
      <a href="#" class="nav-link"><i class="fa-regular fa-user"></i></a>
      <a th:href="@{/logout}" class="nav-link logout">
        <i class="fa-solid fa-right-from-bracket"></i>
      </a>
    </nav>
  </header>
  
  

<!--The box containing color-coded keys for the time booking-->
<h1>Välja tvättid</h1>
<div class="legend">
    <div class="legend-items">
      <div class="legend-item"><div class="color-box gron"></div><span>Ledig</span></div>
      <div class="legend-item"><div class="color-box rod"></div><span>Upptaget</span></div>
      <div class="legend-item"><div class="color-box bla"></div><span>Egen tid</span></div>
    </div>
</div>

<!--Calendar input with a label that deactivates past dates-->
<input type="date" id="datePicker" onfocus="disablePastDates()" />
<!--Big button to select time-->
<button type="button" id="selectDate"></button>
<!--A container element to append divs with time slots-->
<div id="slotsContainer"></div>
<!--Booking confirmation message to the user-->
<h3 id="booking-confirmation"></h3>
<!--A list of a specific user bookings. Currently not in use-->
<ul id="savedDates"></ul>
<script>
    //Click event for selectDate button
    document.addEventListener("DOMContentLoaded", () => {
        const saveBtn = document.getElementById("selectDate");
        saveBtn.innerText = "Välj datum"
        saveBtn.addEventListener("click", checkAvailability);
    });

    //Function that "grays out" or inactivates the dates on the calendar that
    //have already passed. Used on calendar element onfocus
    function disablePastDates() {
        let today = new Date();
        let dd = String(today.getDate()).padStart(2, '0');
        let mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0 in the calendar element
        let yyyy = today.getFullYear();

        today = yyyy + '-' + mm + '-' + dd;
        document.getElementById("datePicker").setAttribute("min", today);
    }

  function checkAvailability() {
    const selectedDate = document.getElementById("datePicker").value;
    if (!selectedDate) return alert("Please select a date");

    //API call to availability endpoint to check the available times on that specific date
    fetch(`http://127.0.0.1:8080/u/laundry-booking/availability?date=${selectedDate}`)
            .then(res => {
              if (!res.ok) throw new Error("Network error");

              //The response send is always on JSON
              return res.json();
            })
        .then(slots => {
            const container = document.getElementById("slotsContainer");

            //Lines 203-225 ensure that only the bookable times on a specific day are shown.
            //If a time slot has passed for that specific day, it won't show on the list
            //Because the time slots are stored as labels (strings), they need to be converted
            //to LocalTime in order to check if they have passed or not

            const now = new Date();
            const todayStr = now.toISOString().split("T")[0];
            container.innerHTML = "<h3>Lediga tider:</h3>";

            const filteredSlots = slots.filter(slot => {
                if (selectedDate === todayStr) {
                    const endHourMinute = slot.endTime;
                    const [endHour, endMinute] = endHourMinute.split(":").map(Number);
                    const slotTime = new Date();
                    slotTime.setHours(endHour, endMinute, 0, 0);

                    if (slotTime <= now) return false;
                }
                return true;
            });

            if (filteredSlots.length === 0) {
                const ingaLedigaTider = document.createElement("div");
                ingaLedigaTider.innerHTML = "<p>Inga lediga tider</p>";
                container.appendChild(ingaLedigaTider);
                return;
            }

            //Here we take the bookable times and append them to the
            //container we had previously created, along with an
            //individual button for each time to book it
            filteredSlots.forEach(slot => {
                const timeSlot = document.createElement("div");
                timeSlot.className = "time-slot";
                timeSlot.textContent = `${slot.label}`;

                const timeSlotButton = document.createElement("button");
                timeSlotButton.className = "time-slot button";
                timeSlotButton.innerText = "Boka";
                timeSlot.appendChild(timeSlotButton);

                container.appendChild(timeSlot);

                //This event calls on function createBpoking (declared below)
                timeSlotButton.addEventListener("click", () => {
                    createBooking(slot.id);
                });
            });
        })
        .catch(err => {
            console.error("Error checking availability:", err);
        });

  }

  function createBooking(slotId) {
      const date = document.getElementById("datePicker").value;

      //This promt element is a temporary fix. Needs to be exchanged
      //for a custom text field
      const notes = prompt("Enter notes for your booking (optional):") || "";

      //Parameters to be sent as a POST request to server and then be stored
      //in database
      const params = new URLSearchParams();
      params.append("date", date);
      params.append("time_slot", slotId);
      params.append("notes", notes);

      fetch("/u/laundry-booking/create", {
          method: "POST",
          headers: {
              //Format in which the parameters are to be sent, as key-value pairs
              //the url
              "Content-Type": "application/x-www-form-urlencoded"
          },
          body: params
      })
          .then(res => {
              if (!res.ok) throw new Error("Booking failed");
              return res.json();
          })
          .then(data => {
              let slotsContainer = document.getElementById("slotsContainer");
              slotsContainer.innerHTML = '';

              let bookingConfirmation = document.createElement("H3");
              bookingConfirmation.innerText = `Din bokning på ${date} är bekräftad`;
              bookingConfirmation.style.marginBottom = "1rem";
              slotsContainer.appendChild(bookingConfirmation);

              //The confirmation message is shown for 2 seconds and then the
              //page reloads
               window.setTimeout(() => window.location.href = data.url, 2000);
          })
          .catch(error => {
              alert(error.message);
          });
  }

</script>

<!-- Mina Bokningar Sektion -->
<h2 style="margin-top: 60px; font-size: 24px; color: #144953;">Mina bokningar</h2>
<div id="myBookings" style="max-width: 700px; width: 100%; margin-top: 20px;"></div>




</body>
</html>