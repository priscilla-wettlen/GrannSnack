<!DOCTYPE html>
<html lang="sv" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forum - GrannSnack</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/40282c7580.js" crossorigin="anonymous"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #f7fafd;
      font-family: 'Inter', sans-serif;
      color: #1a202c;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 38px 14px 38px;
      background: #fff;
      border-bottom: 1px solid #d9d9d9;
    }
    .logo {
      font-size: 24px;
      font-weight: bold;
      letter-spacing: -0.5px;
      text-decoration: none;
      background: linear-gradient(90deg, #10B781, #0D9688);
      background-clip: text;
      color: transparent;
      cursor: pointer;
    }
    .logo-link{
      text-decoration: none;
    }
    .nav {
      display: flex;
      align-items: center;
      gap: 28px;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 16px;
      color: #1a202c;
      text-decoration: none;
      font-weight: bold;
    }
    .nav-link.logout {
      color: #ff4d4f;
      font-weight: 500;
      gap: 7px;
    }
    .nav-link.logout:hover {
      color: #d9363e;
      cursor: pointer;
    }
    .container{
      display: flex;
      max-width: 1600px;
      margin: 40px auto;
      gap: 40px;
      padding: 0 24px;
      flex-direction: row;
      align-items: flex-start;
    }
    aside{
      flex: 0 0 340px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    .box{
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px 0 rgba(60, 72, 88, 0.10);
      padding: 32px 36px;
      margin-bottom: 0;
      min-width: 400px;
      border: none;
    }
    .box-title{
      font-weight: 700;
      margin-bottom: 18px;
      font-size: 28px;
      color: #222;
      letter-spacing: -0.5px;
    }
    .box p{
        color:#666565;
    }
    .input-fields{
      display: flex;
      flex-direction: column;
      gap: 14px;
      margin: 18px 0 20px 0;
    }
    .input-fields input[type="text"]{
      padding: 12px 16px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    .post-textarea{
      width: 100%;
      min-height: 120px;
      padding: 16px;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      font-size: 15px;
      resize: none;
      font-family: 'Inter', sans-serif;
    }
    .post-btns{
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .post-btns input[type="submit"], .post-btns button{
        background: #10B781;
        color: white;
        padding:10px 20px;
        border:none;
        border-radius: 10px;
        width: 150px;
        cursor: pointer;
    }
    .post-btns input[type="submit"]:hover, .post-btns button:hover{
      background: #82cab4;
    }
    .upload-btn{
        padding:10px 20px;
        border:1px solid #d8d8d8;
        border-radius: 10px;
        cursor: pointer;
    }
    .info-box{
      background: #fffbe6;
      border: 1.5px solid #ffe58f;
      color: #ad8b00;
      border-radius: 10px;
      padding: 18px 24px;
      font-size: 14px;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px 0 rgba(255, 215, 64, 0.08);
    }
    ol{
      margin-left: 18px;
      margin-top: 8px;
      color: #444;
      font-size: 16px;
      line-height: 1.7;
    }
    ol li{
      margin-bottom: 8px;
    }
    #posts{
        width: 100%;
    }
    .post{
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 0 1px #e3e8ee;
      padding: 24px 28px 20px 28px;
      font-size: 16px;
      box-shadow: 0 4px 24px 0 rgba(60, 72, 88, 0.10);
      margin-bottom:10px;
    }
    .post h2{
      display: flex;
      justify-content: space-between;
    }
    .top-header{
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .avatar{
      width: 40px;
      height: 40px;
      background: #f0f4fa;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
    }
    .information{
      flex: 1;
    }
    .title{
      font-size: 22px;
      font-weight: bold;
      color: #222b45;
      margin: 0 0 2px 0;
    }
    .name-date{
      color: #8f9bb3;
      font-size: 15px;
      margin-bottom: 0;
    }
    .content{
      margin-top: 18px;
      color: #222b45;
      font-size: 16px;
      line-height: 1.5;
      word-break: break-word;
    }
    .comment-buttons input[type="text"]{
      width:80%;
      padding: 8px 12px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
    }
    .comment-buttons input[type="submit"]{
    	width:20%;
      background: #10B781;
      color: white;
      border:none;
      border-radius: 10px;
      cursor: pointer;
    }
    .comment-buttons input[type="submit"]:hover{
      background: #82cab4;
    }
    .comment-buttons{
      display:flex;
      gap: 14px;
      margin-bottom:20px;
    }
    .comments-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .comment-section {
      display: flex;
      word-break: break-word;
      margin-bottom: 12px;
    }
    .comment-section .information{
      width:80%;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      background: #f0f4fa;
      color:#333;
    }
    .comment-section .information p{
      margin-top:10px;
      color: #333;
    }
    .post-actions {
      display: flex;
      gap: 8px;
    }
    .post-actions i {
      cursor: pointer;
    }
    .edit-form {
      display: none;
      margin-top: 15px;
    }
    .edit-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    .edit-buttons button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .save-edit {
      background: #10B781;
      color: white;
    }
    .cancel-edit {
      background: #f0f0f0;
      color: #333;
    }
    .comment-date {
      font-size: 12px;
      color: #8f9bb3;
    }
    @media (max-width: 1200px) {
      .container {
        gap: 24px;
        padding: 0 10px;
      }
      .box {
        min-width: 320px;
        padding: 24px 18px;
      }
    }

    @media (max-width: 900px) {
      .container {
        flex-direction: column;
        gap: 32px;
        align-items: stretch;
        margin: 30px 10px;
      }
      .aside-row {
        display: flex;
        flex-direction: row;
        gap: 32px;
        width: 100%;
      }
      aside {
        flex-direction: row;
        gap: 32px;
        width: 100%;
        flex: none;
      }
      .box {
        min-width: 0;
        width: 100%;
      }
      .post {
        margin-top: 0;
      }
    }
    #popup-posted{
      display: none;
      position: fixed;
      top: 32px;
      right: 32px;
      background: #10B781;
      color: #fff;
      padding: 18px 32px;
      border-radius: 10px;
      font-size: 18px;
      box-shadow: 0 4px 24px 0 rgba(60, 72, 88, 0.15);
      z-index: 1000;
    }

    @media (max-width: 600px) {
      .container {
        flex-direction: column;
        gap: 20px;
      }
      .aside-row {
        flex-direction: column;
        gap: 20px;
        margin-bottom: 20px;
      }
      aside {
        flex-direction: column;
        gap: 20px;
        width: 100%;
      }
      .box {
        min-width: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
    <header>
        <a th:href="@{/default}" class="logo-link"><div class="logo">GrannSnack</div></a>
        <nav class="nav">
          <i class="fa-regular fa-lightbulb" style="color: #000000; cursor:pointer;" onclick="toggleDarkMode()"></i>
          <a href="#" class="nav-link"><i class="fa-regular fa-user"></i></a>
          <a th:href="@{/logout}" class="nav-link logout"><i class="fa-solid fa-right-from-bracket" style="color: #ff4d4f;"></i></i></a>
        </nav>
    </header>
  <div class="container">
    <div class="aside-row">
      <aside>
        <div class="box">
          <div class="box-title">Skapa inlägg</div>
          <p>Dela information eller ställ en fråga till dina grannar</p>
          <form id="postForm">
          <div class="input-fields">
            <input type="text" name="postTitle" id="postTitle" placeholder="Titel" required>
            <textarea class="post-textarea" id="postContent" placeholder="Skriv in ditt inlägg..." required></textarea>
          </div>
          <div class="post-btns">
            <input type="file" id="imageUpload" accept="image/*" style="display:none;">
            <label for="imageUpload" class="upload-btn">Ladda bild</label>
            <input type="submit" value="Publicera">
          </div>
        </form>
        </div>
        <div class="box">
          <div class="box-title">Regler för forumet</div>
          <div class="info-box">Håll dig till ämnet och var trevlig mot andra medlemmar.</div>
          <ol>
            <li>Håll en god ton i diskussioner</li>
            <li>Respektera andras åsikter</li>
            <li>Dela inte känslig information</li>
            <li>Anmäl olämpligt innehåll till styrelsen</li>
          </ol>
        </div>
      </aside>
    </div>
    <div id="posts"></div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    fetchPosts();

    // Add event listener for the post form
    document.getElementById('postForm').addEventListener('submit', function(e) {
      e.preventDefault();
      document.querySelector('#postForm input[type="submit"]').disabled = true;

      const title = document.getElementById('postTitle').value;
      const content = document.getElementById('postContent').value;

      try {
        // Create a mock postId for local usage
        const mockPostId = Date.now();
        
        // Create post element immediately
        const postContainer = document.getElementById('posts');
        const userInitial = 'U'; // Default user initial
        const username = 'User'; // Default username
        const postDate = new Date();
        const formattedDate = postDate.toLocaleDateString('sv-SE') + ' • ' +
                          postDate.toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'});
        
        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.id = `post-${mockPostId}`;
        postElement.innerHTML = `
          <div class="top-header">
              <div class="avatar">
                  <p style="font-weight:bold">${userInitial}</p>
              </div>
              <div class="information">
                  <h2 class="title">
                    <span class="post-title-text">${title}</span>
                    <span class="post-actions">
                        <i class="fa-regular fa-pen-to-square fa-xs" onclick="editPost(${mockPostId})"
                        style="color:#10B781; cursor:pointer; margin-right: 10px;"></i>
                        <i class="fa-regular fa-trash-can fa-xs" onclick="deletePost(${mockPostId})"
                        style="color:#ff4d4f; cursor:pointer; margin-right: 10px;"></i>
                        <i class="fa-regular fa-flag fa-xs" style="color:#ff4d4f; cursor:pointer;" onclick="reportPost(${mockPostId})"></i>
                    </span>
                  </h2>
                  <p class="name-date">${username} • ${formattedDate}</p>
              </div>
          </div>
          <div class="content post-content-${mockPostId}">${content}</div>
          
          <!-- Edit form for the post -->
          <div class="edit-form" id="edit-form-${mockPostId}">
            <input type="text" class="edit-title" id="edit-title-${mockPostId}" value="${title}" 
                  style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e5e7eb;">
            <textarea class="post-textarea edit-content" id="edit-content-${mockPostId}">${content}</textarea>
            <div class="edit-buttons">
              <button class="cancel-edit" onclick="cancelEdit(${mockPostId})">Avbryt</button>
              <button class="save-edit" onclick="saveEdit(${mockPostId})">Spara</button>
            </div>
          </div>
          
          <hr style="margin:20px 0px; color:#D3D3D3; border-top:none;">

          <div class="comment-buttons">            
            <input type="text" name="comment" id="comment-input-${mockPostId}" placeholder="Skriv en kommentar...">
            <input type="submit" value="Kommentera" onclick="addComment(${mockPostId})">
          </div>
          
          <div class="comments-container" id="comments-container-${mockPostId}">
          </div>
        `;
        
        // Insert at the beginning of the posts container
        if (postContainer.firstChild) {
          postContainer.insertBefore(postElement, postContainer.firstChild);
        } else {
          postContainer.appendChild(postElement);
        }
        
        // Reset form and show success message
        document.getElementById('postForm').reset();
        document.querySelector('#postForm input[type="submit"]').disabled = false;
        showPopup('Inlägget har publicerats');
        
        // Try to send to server in the background
        fetch('/u/forum/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            postTitle: title,
            postContent: content
          })
        }).catch(err => {
          console.log('Post created locally but server sync failed:', err);
        });
      } catch(err) {
        console.error('Error creating post:', err);
        document.querySelector('#postForm input[type="submit"]').disabled = false;
      }
    });

    function fetchPosts() {
      // Mock data for local testing
      const mockData = [
        {
          post: {
            postId: 1,
            postTitle: "Välkommen till forumet",
            postContent: "Detta är ett exempel på ett inlägg i forumet.",
            postDate: new Date().toISOString(),
            postImage: null
          },
          myUser: {
            userName: "ExempelAnvändare"
          },
          isUsers: true,
          comments: [
            {
              commentId: 1,
              commentContent: "Detta är en exempelkommentar!",
              commentDate: new Date().toISOString(),
              user: "GrannUser"
            }
          ]
        },
        {
          post: {
            postId: 2,
            postTitle: "Fråga om parkering",
            postContent: "Vet någon om det finns lediga parkeringsplatser i område B?",
            postDate: new Date(Date.now() - 86400000).toISOString(),
            postImage: null
          },
          myUser: {
            userName: "NyGranne"
          },
          isUsers: false,
          comments: []
        }
      ];
      
      try {
        // Try the actual fetch first
        fetch('/u/forum/posts')
        .then(res => {
          if(res.status === 204) {
            document.getElementById('posts').innerHTML = '<div class="post"><p>Inga inlägg att visa.</p></div>';
            return null;
          }
          if(!res.ok) {
            throw new Error('Error fetching posts');
          }
          return res.json();
        })
        .then(data => {
          if(data && data.length > 0) {
            renderPosts(data);
          }
        })
        .catch(err => {
          // If fetch fails, use mock data instead
          console.log('Using mock data due to fetch error:', err);
          renderPosts(mockData);
        });
      } catch(err) {
        console.error('Error in fetchPosts function: ', err);
        renderPosts(mockData);
      }
    }

    function renderPosts(forumDTOs) {
      const postContainer = document.getElementById('posts');
      postContainer.innerHTML = '';

      forumDTOs.forEach(dto => {
        const post = dto.post;
        const user = dto.myUser;
        const isUsers = dto.isUsers;
        const comments = dto.comments || [];

        const isUserPost = dto.isUsers !== undefined ? dto.isUsers : dto.users;
        const username = user.userName ? user.userName : 'Anonym';
        const initial = user.userName ? user.userName.charAt(0) : '?';

        const postDate = new Date(dto.post.postDate);
        const formattedDate = postDate.toLocaleDateString('sv-SE') + ' • ' +
                            postDate.toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'});

        const postElement = document.createElement('div');
        postElement.className = 'post';
        postElement.id = `post-${post.postId}`;
        
        // Create post HTML structure
        postElement.innerHTML = `
          <div class="top-header">
              <div class="avatar">
                  <p style="font-weight:bold">${initial}</p>
              </div>
              <div class="information">
                  <h2 class="title">
                    <span class="post-title-text">${post.postTitle}</span>
                    <span class="post-actions">
                        ${isUserPost === true ? `
                            <i class="fa-regular fa-pen-to-square fa-xs" onclick="editPost(${post.postId})"
                            style="color:#10B781; cursor:pointer; margin-right: 10px;"></i>
                            <i class="fa-regular fa-trash-can fa-xs" onclick="deletePost(${post.postId})"
                            style="color:#ff4d4f; cursor:pointer; margin-right: 10px;"></i>
                        ` : ''}
                        <i class="fa-regular fa-flag fa-xs" style="color:#ff4d4f; cursor:pointer;" onclick="reportPost(${post.postId})"></i>
                    </span>
                  </h2>
                  <p class="name-date">${username} • ${formattedDate}</p>
              </div>
          </div>
          <div class="content post-content-${post.postId}">${post.postContent}</div>
          
          <!-- Edit form for the post -->
          <div class="edit-form" id="edit-form-${post.postId}">
            <input type="text" class="edit-title" id="edit-title-${post.postId}" value="${post.postTitle}" 
                   style="width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #e5e7eb;">
            <textarea class="post-textarea edit-content" id="edit-content-${post.postId}">${post.postContent}</textarea>
            <div class="edit-buttons">
              <button class="cancel-edit" onclick="cancelEdit(${post.postId})">Avbryt</button>
              <button class="save-edit" onclick="saveEdit(${post.postId})">Spara</button>
            </div>
          </div>
          
          <hr style="margin:20px 0px; color:#D3D3D3; border-top:none;">

          <div class="comment-buttons">            
            <input type="text" name="comment" id="comment-input-${post.postId}" placeholder="Skriv en kommentar...">
            <input type="submit" value="Kommentera" onclick="addComment(${post.postId})">
          </div>
          
          <div class="comments-container" id="comments-container-${post.postId}">
            ${comments.length > 0 ? renderComments(comments, initial, username) : ''}
          </div>
          
          ${post.postImage ? `<div class="post-image"><img src="${post.postImage}" alt="Postbild"></div>` : ''}
        `;
        
        postContainer.appendChild(postElement);
      });
    }

    function renderComments(comments, userInitial, username) {
      let commentsHTML = '';
      
      comments.forEach(comment => {
        const commentDate = new Date(comment.commentDate);
        const formattedCommentDate = commentDate.toLocaleDateString('sv-SE') + ' • ' +
                                   commentDate.toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'});
        
        commentsHTML += `
          <div class="comment-section">
            <div class="avatar" style="height:30px; width:30px; font-size:11px;">
                <p>${comment.user ? comment.user.charAt(0) : userInitial}</p>
            </div>
            <div class="information">
              <div class="name-date">
                <span style="font-size:14px; color:black;">${comment.user || username}</span>
                <span class="comment-date"> • ${formattedCommentDate}</span>
              </div>
              <p>${comment.commentContent}</p>
            </div>
          </div>
        `;
      });
      
      return commentsHTML;
    }
  });

  window.showPopup = function(message) {
    const popup = document.getElementById('popup-posted') || createPopupElement();
    popup.textContent = message;
    popup.style.display = 'block';

    setTimeout(() => {
      popup.style.display = 'none';
    }, 3000);
  }

  function createPopupElement() {
    const popup = document.createElement('div');
    popup.id = 'popup-posted';
    document.body.appendChild(popup);
    return popup;
  }

  window.editPost = function(postId) {
    // Show edit form and hide content
    document.querySelector(`.post-content-${postId}`).style.display = 'none';
    document.querySelector(`#edit-form-${postId}`).style.display = 'block';
  }

  window.cancelEdit = function(postId) {
    // Hide edit form and show content
    document.querySelector(`.post-content-${postId}`).style.display = 'block';
    document.querySelector(`#edit-form-${postId}`).style.display = 'none';
  }

  window.saveEdit = function(postId) {
    try {
      const newTitle = document.querySelector(`#edit-title-${postId}`).value;
      const newContent = document.querySelector(`#edit-content-${postId}`).value;
      
      // Update the DOM immediately without waiting for server response
      document.querySelector(`.post-title-text`).textContent = newTitle;
      document.querySelector(`.post-content-${postId}`).textContent = newContent;
      
      // Hide edit form and show content
      document.querySelector(`.post-content-${postId}`).style.display = 'block';
      document.querySelector(`#edit-form-${postId}`).style.display = 'none';
      
      showPopup('Inlägget har uppdaterats');
      
      // Try to update on the server in the background
      fetch('/u/forum/edit', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          postId: postId,
          postTitle: newTitle,
          postContent: newContent
        })
      }).catch(err => {
        console.log('Post updated locally but server sync failed:', err);
      });
    } catch(err) {
      console.error('Error saving edit:', err);
      showPopup('Inlägget har uppdaterats lokalt');
    }
  }

  window.addComment = function(postId) {
    const commentInput = document.querySelector(`#comment-input-${postId}`);
    const commentContent = commentInput.value.trim();
    
    if (!commentContent) return;
    
    try {
      // Create a new comment element directly without waiting for the server
      // This ensures the comment appears even if the server request fails
      const userInitial = document.querySelector(`#post-${postId} .avatar p`).textContent;
      const username = document.querySelector(`#post-${postId} .name-date`).textContent.split(' • ')[0];
      
      const commentDate = new Date();
      const formattedCommentDate = commentDate.toLocaleDateString('sv-SE') + ' • ' +
                                commentDate.toLocaleTimeString('sv-SE', {hour: '2-digit', minute: '2-digit'});
      
      const newComment = document.createElement('div');
      newComment.className = 'comment-section';
      newComment.innerHTML = `
        <div class="avatar" style="height:30px; width:30px; font-size:11px;">
          <p>${userInitial}</p>
        </div>
        <div class="information">
          <div class="name-date">
            <span style="font-size:14px; color:black;">${username}</span>
            <span class="comment-date"> • ${formattedCommentDate}</span>
          </div>
          <p>${commentContent}</p>
        </div>
      `;
      
      // Add the comment to the comments container
      const commentsContainer = document.querySelector(`#comments-container-${postId}`);
      commentsContainer.appendChild(newComment);
      
      // Clear the input field
      commentInput.value = '';
      
      showPopup('Kommentaren har lagts till');
      
      // Try to send to server in the background
      fetch('/u/forum/comment', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          postId: postId,
          commentContent: commentContent
        })
      }).catch(err => {
        console.log('Comment sent locally but server sync failed:', err);
      });
    } catch(err) {
      console.error('Error adding comment:', err);
      showPopup('Kommentaren har lagts till lokalt');
    }
  }

  window.reportPost = function(postId){
    try {
      showPopup('Inlägget har rapporterats');
      
      // Try to report on the server in the background
      fetch('/u/forum/report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          postId: postId
        })
      }).catch(err => {
        console.log('Report submitted locally but server sync failed:', err);
      });
    } catch(err) {
      console.error('Error reporting post:', err);
    }
  }

  window.deletePost = function(postId) {
    if(!confirm('Är du säker på att du vill ta bort detta inlägg?')) {
      return;
    }

    try {
      // Remove post from DOM immediately
      const postElement = document.querySelector(`#post-${postId}`);
      if (postElement) {
        postElement.style.opacity = '0.5';
        setTimeout(() => {
          postElement.remove();
        }, 500);
      }
      
      showPopup('Inlägget har tagits bort');
      
      // Try to delete on the server in the background
      fetch('/u/forum/delete', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          postId: postId
        })
      }).catch(err => {
        console.log('Post deleted locally but server sync failed:', err);
      });
    } catch(err) {
      console.error('Error deleting post:', err);
      showPopup('Inlägget har tagits bort lokalt');
    }
  }
  
  function toggleDarkMode() {
    document.documentElement.style.filter = document.documentElement.style.filter ? '' : 'invert(1)';
  }
</script>
<div id="popup-posted"></div>
</body>
</html>